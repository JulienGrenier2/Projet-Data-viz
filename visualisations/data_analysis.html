<!DOCTYPE html>

<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="https://openlayers.org/en/v5.3.0/css/ol.css" type="text/css">
  <script src="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/build/ol.js"></script>
  <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="../scripts/build_latlong.js"></script>
  <script src="../scripts/build_map.js"></script>
  <script src="../scripts/build_distrib.js"></script>
  <script src="../scripts/support.js"></script>
  <link rel="icon" href="../img/icon.png" />
  <style>
    body {
      background-color: #333;
      color: #e6eeff;
      font-family: century-gothic, arial;
    }

    .map {
      height: 400px;
      width: 100%;
    }
  </style>
</head>

<body>
  <h1 id="titre">Premier essai de graphique</h1>
  <div id="loading"></div>
  <div id="map" class="map"></div>
  <div id="distribution"></div>
  <div id="graph"></div>
  <script>
    // Create the svg
    var width = window.innerWidth - 20;
    var height = window.innerHeight - document.getElementById('titre').clientHeight - 100;
    var loading = d3.select("#loading").append("svg")
      .attr("width", width)
      .attr("height", height);
    var loading_text = loading.append("text")
      .attr("x", width / 2 - 50)
      .attr("y", height / 2)
      .attr("fill", "#ccc")
      .attr("font-size", "20pt")
      .text("Loading");
    var loading_img = loading.append("image")
      .attr("x", width / 2 + 60)
      .attr("y", height / 2 - 25)
      .attr("width", 30)
      .attr("xlink:href", "../img/loading.gif")
    // load data
    var data = [];
    var dates = [];
    var distances = [];
    var color = d3.scaleOrdinal(d3.schemeCategory20)
    d3.json('../data/data.json', function(e, d) {
      locations = d; //['locations'];
      console.log(locations.slice(0, 1000))
      for (var i = 0; i < locations.length; i++) {
        loc = locations[locations.length - i - 1];
        dates.push(new Date(Number(loc['timestampMs'])));
        // As we have a lot of data, we will compute the distance only every 5 points
        // if (i % 5 == 0) {
        //   if (i == 0) {
        //     prev
        //   }
        //   info = {}
        //   info['date'] = new Date(Number(loc['timestampMs']));
        //   // ACOS(SIN(RADIANS(B2))*SIN(RADIANS(B3))+COS(RADIANS(B2))*COS(RADIANS(B3))*COS(RADIANS(C2-C3)))*6371
        //   data.push(info);
        // }
        // As we have a lot a data, we will only use a point out of 100
        if (i % 1 == 0) {
          info = {}
          info['date'] = new Date(Number(loc['timestampMs']));
          info['lat'] = Math.floor(loc['latitudeE7'] / 1e3) / 1e4;
          info['long'] = Math.floor(loc['longitudeE7'] / 1e3) / 1e4;
          info['activity'] = loc['activity']
          if (loc['altitude']) {
            info['alt'] = Math.floor(loc['altitude']);
          } else {
            if (i == 0) {
              info['alt'] = 0
            } else {
              info['alt'] = data[i / 1 - 1]['alt'];
            }
          }
          data.push(info);
        }
      }
      loading.remove();

      main();
    })

    function main() {
      build_map(data.slice(500, 1000))
      d3.select('#distribution')
        .append('p')
        .html('Voici la distribution des données à disposition')
      build_distrib(dates)

      d3.select('#graph')
        .append('p')
        .html("Voici l'évolution de la longitude, de la latitude et de l'altitude de notre position.")
      // build_latlong(data)
    }
  </script>
</body>